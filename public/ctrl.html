<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Control Panel - Moomhe</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { getFirestore, collection, query, orderBy, limit, getDocs, where, doc, setDoc, addDoc, deleteDoc, getDoc, serverTimestamp, updateDoc, or } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
    import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';

    const firebaseConfig = {
      apiKey: "AIzaSyDexERfe7htllA1aq7vlbnyQAmfgjx6HnI",
      authDomain: "moomhe-6de30.firebaseapp.com",
      projectId: "moomhe-6de30",
      storageBucket: "moomhe-6de30.firebasestorage.app",
      messagingSenderId: "951714207506",
      appId: "1:951714207506:web:0e3a50f5d663095e4345cb",
      measurementId: "G-S5QD3W3XV9"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    const ADMIN_UID = 'OBAc1IAmd8fPhOJyKFl0PXx5Kqu1';
    
    // Current tab state
    let currentTab = 'history';
    let selectedCategory = null;
    let categoriesData = [];

    // DOM Elements
    const loginSection = document.getElementById('login-section');
    const adminSection = document.getElementById('admin-section');
    const errorMsg = document.getElementById('error-msg');
    const historyGrid = document.getElementById('history-grid');
    const loadingIndicator = document.getElementById('loading');
    const userInfo = document.getElementById('user-info');

    // Chart instance
    let generationChart = null;

    // Load image generation stats for last 2 weeks
    async function loadGenerationStats() {
      const chartContainer = document.getElementById('generation-chart-container');
      const chartLoading = document.getElementById('chart-loading');
      
      if (!chartContainer) return;
      
      chartLoading.classList.remove('hidden');
      
      try {
        // Calculate date 14 days ago
        const twoWeeksAgo = new Date();
        twoWeeksAgo.setDate(twoWeeksAgo.getDate() - 14);
        twoWeeksAgo.setHours(0, 0, 0, 0);
        
        // Query userHistory for imageGeneration requests in last 2 weeks
        const statsQuery = query(
          collection(db, 'userHistory'),
          where('requestType', '==', 'imageGeneration'),
          where('createdAt', '>=', twoWeeksAgo),
          orderBy('createdAt', 'asc')
        );
        
        const snapshot = await getDocs(statsQuery);
        
        // Aggregate by day
        const dailyCounts = {};
        
        // Initialize all days in range with 0
        for (let i = 13; i >= 0; i--) {
          const date = new Date();
          date.setDate(date.getDate() - i);
          const dateKey = date.toISOString().split('T')[0];
          dailyCounts[dateKey] = 0;
        }
        
        // Count records per day
        snapshot.forEach((doc) => {
          const data = doc.data();
          const createdAt = data.createdAt?.toDate?.();
          if (createdAt) {
            const dateKey = createdAt.toISOString().split('T')[0];
            if (dailyCounts.hasOwnProperty(dateKey)) {
              dailyCounts[dateKey]++;
            }
          }
        });
        
        // Prepare chart data
        const labels = Object.keys(dailyCounts).map(dateKey => {
          const date = new Date(dateKey);
          return date.toLocaleDateString('he-IL', { day: 'numeric', month: 'short' });
        });
        const data = Object.values(dailyCounts);
        const totalGenerations = data.reduce((sum, val) => sum + val, 0);
        
        // Update total count display
        document.getElementById('total-generations').textContent = totalGenerations;
        document.getElementById('avg-daily').textContent = Math.round(totalGenerations / 14);
        
        // Create or update chart
        const ctx = document.getElementById('generationChart').getContext('2d');
        
        if (generationChart) {
          generationChart.destroy();
        }
        
        generationChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [{
              label: '×™×¦×™×¨×•×ª ×ª××•× ×”',
              data: data,
              backgroundColor: 'rgba(147, 51, 234, 0.5)',
              borderColor: 'rgba(147, 51, 234, 1)',
              borderWidth: 1,
              borderRadius: 4
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false
              },
              tooltip: {
                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                titleColor: '#fff',
                bodyColor: '#fff',
                padding: 12,
                displayColors: false,
                callbacks: {
                  title: function(context) {
                    return context[0].label;
                  },
                  label: function(context) {
                    return `${context.parsed.y} ×™×¦×™×¨×•×ª`;
                  }
                }
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  color: '#9ca3af',
                  stepSize: 1
                },
                grid: {
                  color: 'rgba(75, 85, 99, 0.3)'
                }
              },
              x: {
                ticks: {
                  color: '#9ca3af',
                  maxRotation: 45,
                  minRotation: 45
                },
                grid: {
                  display: false
                }
              }
            }
          }
        });
        
      } catch (error) {
        console.error('Error loading generation stats:', error);
        document.getElementById('chart-error').textContent = '×©×’×™××” ×‘×˜×¢×™× ×ª ×”×¡×˜×˜×™×¡×˜×™×§×•×ª: ' + error.message;
        document.getElementById('chart-error').classList.remove('hidden');
      } finally {
        chartLoading.classList.add('hidden');
      }
    }

    // Check auth state
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        if (user.uid === ADMIN_UID) {
          loginSection.classList.add('hidden');
          adminSection.classList.remove('hidden');
          userInfo.textContent = `××—×•×‘×¨ ×›: ${user.email}`;
          await loadGenerationStats();
          await loadHistory();
          await loadCategories();
        } else {
          errorMsg.textContent = '××™×Ÿ ×œ×š ×”×¨×©××•×ª ×’×™×©×” ×œ×“×£ ×–×”';
          errorMsg.classList.remove('hidden');
          await signOut(auth);
        }
      } else {
        loginSection.classList.remove('hidden');
        adminSection.classList.add('hidden');
      }
    });

    // Login handler
    window.handleLogin = async (e) => {
      e.preventDefault();
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      errorMsg.classList.add('hidden');

      try {
        await signInWithEmailAndPassword(auth, email, password);
      } catch (error) {
        errorMsg.textContent = '×©×’×™××” ×‘×”×ª×—×‘×¨×•×ª: ' + error.message;
        errorMsg.classList.remove('hidden');
      }
    };

    // Logout handler
    window.handleLogout = async () => {
      await signOut(auth);
    };

    // Load history
    async function loadHistory() {
      loadingIndicator.classList.remove('hidden');
      historyGrid.innerHTML = '';

      try {
        const uidFilter = document.getElementById('uid-filter').value.trim();
        
        let historyQuery;
        if (uidFilter) {
          historyQuery = query(
            collection(db, 'userHistory'),
            where('userId', '==', uidFilter),
            orderBy('createdAt', 'desc'),
            limit(50)
          );
        } else {
          historyQuery = query(
            collection(db, 'userHistory'),
            orderBy('createdAt', 'desc'),
            limit(30)
          );
        }

        const snapshot = await getDocs(historyQuery);
        
        if (snapshot.empty) {
          historyGrid.innerHTML = '<p class="text-gray-400 col-span-full text-center py-8">××™×Ÿ ×”×™×¡×˜×•×¨×™×” ×œ×”×¦×’×”</p>';
          updateResultsHeader(0, uidFilter);
          return;
        }

        let count = 0;
        snapshot.forEach((doc) => {
          const data = doc.data();
          // Skip uploaded type records - only show generated
          if (data.type === 'uploaded') return;
          const card = createHistoryCard(doc.id, data);
          historyGrid.appendChild(card);
          count++;
        });
        
        updateResultsHeader(count, uidFilter);

      } catch (error) {
        console.error('Error loading history:', error);
        historyGrid.innerHTML = `<p class="text-red-400 col-span-full text-center py-8">×©×’×™××” ×‘×˜×¢×™× ×ª ×”×™×¡×˜×•×¨×™×”: ${error.message}</p>`;
      } finally {
        loadingIndicator.classList.add('hidden');
      }
    }

    // Refresh handler
    window.refreshHistory = loadHistory;
    window.loadGenerationStats = loadGenerationStats;

    // Clear UID filter
    window.clearUidFilter = () => {
      document.getElementById('uid-filter').value = '';
      loadHistory();
    };

    // Filter by specific user
    window.filterByUser = (userId) => {
      document.getElementById('uid-filter').value = userId;
      loadHistory();
    };

    // Update header based on filter state
    function updateResultsHeader(count, uidFilter) {
      const header = document.getElementById('results-header');
      if (uidFilter) {
        header.innerHTML = `<span class="text-purple-400">${count}</span> ×ª×•×¦××•×ª ×¢×‘×•×¨ UID: <span class="font-mono text-purple-400">${uidFilter.slice(0, 12)}...</span>`;
      } else {
        header.textContent = count > 0 ? `${count} ×”×¨×©×•××•×ª ×”××—×¨×•× ×•×ª` : '30 ×”×¨×©×•××•×ª ×”××—×¨×•× ×•×ª';
      }
    }

    // Create history card
    function createHistoryCard(id, data) {
      const card = document.createElement('div');
      card.className = 'bg-gray-800/50 rounded-2xl border border-gray-700/50 overflow-hidden hover:border-purple-500/50 transition-all';

      const beforeImage = data.originalImageUrl || data.imageUrl || '';
      const afterImage = data.result?.storageUrl || '';
      const prompt = data.originalPrompt || data.prompt || '××™×Ÿ ×¤×¨×•××¤×˜';
      const createdAt = data.createdAt?.toDate?.() || new Date();
      const formattedDate = createdAt.toLocaleDateString('he-IL') + ' ' + createdAt.toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' });

      card.innerHTML = `
        <div class="p-4">
          <div class="flex items-center justify-between mb-3">
            <span class="text-xs text-purple-400 font-medium">${formattedDate}</span>
            <span class="text-xs text-gray-500 font-mono">${id.slice(0, 8)}...</span>
          </div>
          
          <div class="grid grid-cols-2 gap-3 mb-4">
            <div>
              <p class="text-xs text-gray-500 mb-1">×œ×¤× ×™</p>
              ${beforeImage ? 
                `<img src="${beforeImage}" alt="Before" class="w-full h-32 object-cover rounded-lg bg-gray-700 cursor-pointer hover:opacity-80 transition-opacity" onclick="window.open('${beforeImage}', '_blank')">` : 
                `<div class="w-full h-32 bg-gray-700 rounded-lg flex items-center justify-center text-gray-500 text-xs">××™×Ÿ ×ª××•× ×”</div>`
              }
            </div>
            <div>
              <p class="text-xs text-gray-500 mb-1">××—×¨×™</p>
              ${afterImage ? 
                `<img src="${afterImage}" alt="After" class="w-full h-32 object-cover rounded-lg bg-gray-700 cursor-pointer hover:opacity-80 transition-opacity" onclick="window.open('${afterImage}', '_blank')">` : 
                `<div class="w-full h-32 bg-gray-700 rounded-lg flex items-center justify-center text-gray-500 text-xs">××™×Ÿ ×ª×•×¦××”</div>`
              }
            </div>
          </div>
          
          <div class="bg-gray-900/50 rounded-lg p-3">
            <p class="text-xs text-gray-500 mb-1">×¤×¨×•××¤×˜:</p>
            <p class="text-sm text-gray-300 line-clamp-3">${prompt}</p>
          </div>
          
          ${data.generationCount !== undefined ? `<p class="text-xs text-emerald-400 mt-2">ğŸ”¢ Generation Count: ${data.generationCount}</p>` : ''}
          ${data.userId ? `
            <div class="flex items-center gap-2 mt-2">
              <p class="text-xs text-gray-600 font-mono">User: ${data.userId.slice(0, 12)}...</p>
              <button 
                onclick="copyUserId('${data.userId}')" 
                class="copy-btn text-xs bg-gray-700/50 hover:bg-purple-600/30 text-gray-400 hover:text-purple-400 px-2 py-1 rounded transition-all flex items-center gap-1"
                title="Copy full UID"
              >
                <span class="copy-icon">ğŸ“‹</span>
                <span class="copy-text">Copy</span>
              </button>
              <button 
                onclick="filterByUser('${data.userId}')" 
                class="text-xs bg-purple-600/20 hover:bg-purple-600/40 text-purple-400 hover:text-purple-300 px-2 py-1 rounded transition-all flex items-center gap-1"
                title="×”×¦×’ ×¨×§ ××©×ª××© ×–×”"
              >
                ğŸ” ×¡× ×Ÿ
              </button>
            </div>
          ` : ''}
        </div>
      `;

      return card;
    }

    // Copy user ID to clipboard
    window.copyUserId = async (userId) => {
      try {
        await navigator.clipboard.writeText(userId);
        // Show feedback - find the clicked button and update it
        event.target.closest('.copy-btn').innerHTML = '<span class="copy-icon">âœ…</span><span class="copy-text">Copied!</span>';
        setTimeout(() => {
          event.target.closest('.copy-btn').innerHTML = '<span class="copy-icon">ğŸ“‹</span><span class="copy-text">Copy</span>';
        }, 1500);
      } catch (err) {
        console.error('Failed to copy:', err);
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = userId;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        event.target.closest('.copy-btn').innerHTML = '<span class="copy-icon">âœ…</span><span class="copy-text">Copied!</span>';
        setTimeout(() => {
          event.target.closest('.copy-btn').innerHTML = '<span class="copy-icon">ğŸ“‹</span><span class="copy-text">Copy</span>';
        }, 1500);
      }
    };

    // ========== TAB SWITCHING ==========
    window.switchTab = (tab) => {
      currentTab = tab;
      document.getElementById('history-tab-content').classList.toggle('hidden', tab !== 'history');
      document.getElementById('predesigns-tab-content').classList.toggle('hidden', tab !== 'predesigns');
      document.getElementById('users-tab-content').classList.toggle('hidden', tab !== 'users');
      
      document.getElementById('history-tab-btn').classList.toggle('bg-purple-600', tab === 'history');
      document.getElementById('history-tab-btn').classList.toggle('bg-gray-800', tab !== 'history');
      document.getElementById('predesigns-tab-btn').classList.toggle('bg-purple-600', tab === 'predesigns');
      document.getElementById('predesigns-tab-btn').classList.toggle('bg-gray-800', tab !== 'predesigns');
      document.getElementById('users-tab-btn').classList.toggle('bg-purple-600', tab === 'users');
      document.getElementById('users-tab-btn').classList.toggle('bg-gray-800', tab !== 'users');
      
      // Load users when switching to users tab
      if (tab === 'users') {
        loadPremiumUsers();
      }
    };

    // ========== PRESET DESIGNS MANAGEMENT ==========

    // Load all categories
    async function loadCategories() {
      const categoriesList = document.getElementById('categories-list');
      const categorySelect = document.getElementById('category-select');
      if (!categoriesList) return;
      
      categoriesList.innerHTML = '<div class="text-gray-400 text-center py-4">×˜×•×¢×Ÿ ×§×˜×’×•×¨×™×•×ª...</div>';
      categoriesData = [];

      try {
        // Load all categories from preDesigns collection
        const categoriesQuery = query(collection(db, 'preDesigns'), orderBy('createdAt', 'desc'));
        const snapshot = await getDocs(categoriesQuery);
        
        snapshot.forEach((docSnap) => {
          categoriesData.push({ id: docSnap.id, ...docSnap.data() });
        });

        // Update category select dropdown (for adding items)
        if (categorySelect) {
          categorySelect.innerHTML = '<option value="">×‘×—×¨ ×§×˜×’×•×¨×™×”...</option>';
          categoriesData.forEach(cat => {
            categorySelect.innerHTML += `<option value="${cat.id}">${cat.label}</option>`;
          });
        }

        // Render categories list
        if (categoriesData.length === 0) {
          categoriesList.innerHTML = '<div class="text-gray-400 text-center py-4">××™×Ÿ ×§×˜×’×•×¨×™×•×ª ×¢×“×™×™×Ÿ. ×”×•×¡×£ ×§×˜×’×•×¨×™×” ×—×“×©×”.</div>';
          return;
        }

        categoriesList.innerHTML = '';
        for (const cat of categoriesData) {
          // Count items in this category
          const itemsQuery = query(collection(db, 'preDesigns', cat.id, 'items'));
          const itemsSnap = await getDocs(itemsQuery);
          const itemCount = itemsSnap.size;

          const catEl = document.createElement('div');
          catEl.className = `p-4 rounded-xl border cursor-pointer transition-all ${selectedCategory === cat.id ? 'bg-purple-600/20 border-purple-500' : 'bg-gray-800/50 border-gray-700 hover:border-purple-500/50'}`;
          catEl.onclick = () => selectCategory(cat.id);
          catEl.innerHTML = `
            <div class="flex items-center justify-between">
              <div>
                <h3 class="font-medium text-white">${cat.label}</h3>
                <p class="text-xs text-gray-500 font-mono">${cat.id}</p>
              </div>
              <div class="text-left">
                <span class="text-purple-400 font-bold text-lg">${itemCount}</span>
                <p class="text-xs text-gray-500">×¢×™×¦×•×‘×™×</p>
              </div>
            </div>
          `;
          categoriesList.appendChild(catEl);
        }
      } catch (error) {
        console.error('Error loading categories:', error);
        categoriesList.innerHTML = `<div class="text-red-400 text-center py-4">×©×’×™××”: ${error.message}</div>`;
      }
    }

    // Add new category
    window.addCategory = async () => {
      const input = document.getElementById('new-category-input');
      const label = input.value.trim();
      
      if (!label) {
        alert('×”×–×Ÿ ×©× ×§×˜×’×•×¨×™×”');
        return;
      }

      // Create a URL-safe ID from the label
      const categoryId = label
        .toLowerCase()
        .replace(/\s+/g, '_')
        .replace(/[^a-z0-9_\u0590-\u05FF]/g, '');

      if (!categoryId) {
        alert('×©× ×”×§×˜×’×•×¨×™×” ×œ× ×ª×§×™×Ÿ');
        return;
      }

      // Check if already exists
      const existingDoc = await getDoc(doc(db, 'preDesigns', categoryId));
      if (existingDoc.exists()) {
        alert('×§×˜×’×•×¨×™×” ×¢× ×©× ×–×” ×›×‘×¨ ×§×™×™××ª');
        return;
      }

      try {
        await setDoc(doc(db, 'preDesigns', categoryId), {
          label: label,
          createdAt: serverTimestamp()
        });
        
        input.value = '';
        await loadCategories();
        selectCategory(categoryId);
      } catch (error) {
        console.error('Error adding category:', error);
        alert('×©×’×™××” ×‘×”×•×¡×¤×ª ×§×˜×’×•×¨×™×”: ' + error.message);
      }
    };

    // Select category to view items
    async function selectCategory(categoryId) {
      selectedCategory = categoryId;
      await loadCategories(); // Refresh to update selected state
      await loadCategoryItems(categoryId);
      
      // Update add item form
      const categorySelect = document.getElementById('category-select');
      if (categorySelect) categorySelect.value = categoryId;
      
      // Show delete category button
      const deleteSection = document.getElementById('delete-category-section');
      const deleteBtn = document.getElementById('delete-category-btn');
      if (deleteSection && deleteBtn) {
        deleteSection.classList.remove('hidden');
        const category = categoriesData.find(c => c.id === categoryId);
        deleteBtn.textContent = `ğŸ—‘ï¸ ××—×§ ×§×˜×’×•×¨×™×”: ${category?.label || categoryId}`;
        deleteBtn.onclick = () => deleteCategory(categoryId);
      }
    }
    window.selectCategory = selectCategory;

    // Load items for a category
    async function loadCategoryItems(categoryId) {
      const itemsGrid = document.getElementById('category-items-grid');
      const itemsHeader = document.getElementById('items-header');
      if (!itemsGrid) return;

      const category = categoriesData.find(c => c.id === categoryId);
      itemsHeader.textContent = category ? `×¢×™×¦×•×‘×™× - ${category.label}` : '×¢×™×¦×•×‘×™×';
      
      itemsGrid.innerHTML = '<div class="col-span-full text-gray-400 text-center py-8">×˜×•×¢×Ÿ ×¢×™×¦×•×‘×™×...</div>';

      try {
        const itemsQuery = query(
          collection(db, 'preDesigns', categoryId, 'items'),
          orderBy('createdAt', 'desc')
        );
        const snapshot = await getDocs(itemsQuery);

        if (snapshot.empty) {
          itemsGrid.innerHTML = '<div class="col-span-full text-gray-400 text-center py-8">××™×Ÿ ×¢×™×¦×•×‘×™× ×‘×§×˜×’×•×¨×™×” ×–×•</div>';
          return;
        }

        itemsGrid.innerHTML = '';
        snapshot.forEach((docSnap) => {
          const item = docSnap.data();
          const itemEl = document.createElement('div');
          itemEl.className = 'bg-gray-800/50 rounded-xl border border-gray-700 overflow-hidden hover:border-purple-500/50 transition-all';
          
          const createdAt = item.createdAt?.toDate?.();
          const dateStr = createdAt ? createdAt.toLocaleDateString('he-IL') : '';
          
          itemEl.innerHTML = `
            <div class="aspect-video bg-gray-900 relative group">
              <img src="${item.urlThumb || item.url}" alt="${item.title}" class="w-full h-full object-cover">
              <div class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center gap-2">
                <button onclick="window.open('${item.url}', '_blank')" class="bg-purple-600 hover:bg-purple-700 text-white px-3 py-1.5 rounded-lg text-sm">
                  ×¦×¤×” ×‘×ª××•× ×”
                </button>
                <button onclick="deleteDesignItem('${categoryId}', '${docSnap.id}', '${item.url}', '${item.urlThumb || ''}')" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1.5 rounded-lg text-sm">
                  ğŸ—‘ï¸ ××—×§
                </button>
              </div>
            </div>
            <div class="p-3">
              <p class="font-medium text-white">${item.title}</p>
              <p class="text-xs text-gray-500 mt-1">${dateStr}</p>
            </div>
          `;
          itemsGrid.appendChild(itemEl);
        });
      } catch (error) {
        console.error('Error loading items:', error);
        itemsGrid.innerHTML = `<div class="col-span-full text-red-400 text-center py-8">×©×’×™××”: ${error.message}</div>`;
      }
    }

    // Compress image - max dimension on largest side, maintaining aspect ratio
    async function compressImage(file, maxDimension = 1536, quality = 0.8) {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement('canvas');
            
            let width = img.width;
            let height = img.height;
            
            // Scale down based on largest dimension
            if (width > height) {
              if (width > maxDimension) {
                height = (height * maxDimension) / width;
                width = maxDimension;
              }
            } else {
              if (height > maxDimension) {
                width = (width * maxDimension) / height;
                height = maxDimension;
              }
            }
            
            canvas.width = width;
            canvas.height = height;
            
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);
            
            canvas.toBlob((blob) => {
              resolve(blob);
            }, 'image/jpeg', quality);
          };
          img.src = e.target.result;
        };
        reader.readAsDataURL(file);
      });
    }

    // Add new design item
    window.addDesignItem = async (e) => {
      e.preventDefault();
      
      const categoryId = document.getElementById('category-select').value;
      const title = document.getElementById('item-title').value.trim();
      const fileInput = document.getElementById('item-image');
      const file = fileInput.files[0];
      const submitBtn = document.getElementById('add-item-btn');
      const progressBar = document.getElementById('upload-progress');
      
      if (!categoryId || !title || !file) {
        alert('× × ×œ××œ× ××ª ×›×œ ×”×©×“×•×ª');
        return;
      }

      try {
        submitBtn.disabled = true;
        submitBtn.textContent = '××¢×œ×”...';
        progressBar.classList.remove('hidden');
        progressBar.querySelector('.progress-fill').style.width = '10%';

        // Generate unique filename
        const timestamp = Date.now();
        const fileName = `${timestamp}_${file.name.replace(/[^a-zA-Z0-9.]/g, '_').replace(/\.[^.]+$/, '')}.jpg`;
        
        // Compress and upload main image (max 1536px, 0.8 quality - same as app)
        progressBar.querySelector('.progress-fill').style.width = '30%';
        const compressedBlob = await compressImage(file, 1536, 0.8);
        const originalRef = ref(storage, `preDesigns/${categoryId}/${fileName}`);
        await uploadBytes(originalRef, compressedBlob);
        const url = await getDownloadURL(originalRef);
        
        // Create and upload thumbnail (400px, 0.7 quality)
        progressBar.querySelector('.progress-fill').style.width = '60%';
        const thumbnailBlob = await compressImage(file, 400, 0.7);
        const thumbFileName = `thumb_${fileName}`;
        const thumbRef = ref(storage, `preDesigns/${categoryId}/${thumbFileName}`);
        await uploadBytes(thumbRef, thumbnailBlob);
        const urlThumb = await getDownloadURL(thumbRef);
        
        // Save to Firestore
        progressBar.querySelector('.progress-fill').style.width = '90%';
        await addDoc(collection(db, 'preDesigns', categoryId, 'items'), {
          title,
          url,
          urlThumb,
          createdAt: serverTimestamp()
        });

        progressBar.querySelector('.progress-fill').style.width = '100%';
        
        // Reset form
        document.getElementById('item-title').value = '';
        fileInput.value = '';
        document.getElementById('image-preview').classList.add('hidden');
        
        // Reload items
        await loadCategoryItems(categoryId);
        await loadCategories();
        
        alert('×”×¢×™×¦×•×‘ × ×•×¡×£ ×‘×”×¦×œ×—×”!');
      } catch (error) {
        console.error('Error adding design item:', error);
        alert('×©×’×™××” ×‘×”×•×¡×¤×ª ×”×¢×™×¦×•×‘: ' + error.message);
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = '×”×•×¡×£ ×¢×™×¦×•×‘';
        progressBar.classList.add('hidden');
        progressBar.querySelector('.progress-fill').style.width = '0%';
      }
    };

    // Delete design item
    window.deleteDesignItem = async (categoryId, itemId, url, urlThumb) => {
      if (!confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ×¢×™×¦×•×‘ ×–×”?')) return;

      try {
        // Delete from Firestore
        await deleteDoc(doc(db, 'preDesigns', categoryId, 'items', itemId));
        
        // Try to delete from storage (may fail if URL format changed)
        try {
          const urlPath = decodeURIComponent(url.split('/o/')[1].split('?')[0]);
          await deleteObject(ref(storage, urlPath));
          
          if (urlThumb) {
            const thumbPath = decodeURIComponent(urlThumb.split('/o/')[1].split('?')[0]);
            await deleteObject(ref(storage, thumbPath));
          }
        } catch (storageError) {
          console.warn('Could not delete from storage:', storageError);
        }

        // Reload
        await loadCategoryItems(categoryId);
        await loadCategories();
      } catch (error) {
        console.error('Error deleting item:', error);
        alert('×©×’×™××” ×‘××—×™×§×ª ×”×¢×™×¦×•×‘: ' + error.message);
      }
    };

    // Preview image before upload
    window.previewImage = (input) => {
      const preview = document.getElementById('image-preview');
      const previewImg = document.getElementById('preview-img');
      
      if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = (e) => {
          previewImg.src = e.target.result;
          preview.classList.remove('hidden');
        };
        reader.readAsDataURL(input.files[0]);
      } else {
        preview.classList.add('hidden');
      }
    };

    // Delete entire category
    window.deleteCategory = async (categoryId) => {
      const category = categoriesData.find(c => c.id === categoryId);
      if (!confirm(`×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×”×§×˜×’×•×¨×™×” "${category?.label || categoryId}" ×•×›×œ ×”×¢×™×¦×•×‘×™× ×©×‘×”?`)) return;

      try {
        // First delete all items in the category
        const itemsQuery = query(collection(db, 'preDesigns', categoryId, 'items'));
        const snapshot = await getDocs(itemsQuery);
        
        for (const docSnap of snapshot.docs) {
          await deleteDoc(doc(db, 'preDesigns', categoryId, 'items', docSnap.id));
        }
        
        // Delete the category document
        await deleteDoc(doc(db, 'preDesigns', categoryId));
        
        selectedCategory = null;
        document.getElementById('delete-category-section').classList.add('hidden');
        await loadCategories();
        document.getElementById('category-items-grid').innerHTML = '<div class="col-span-full text-gray-400 text-center py-8">×‘×—×¨ ×§×˜×’×•×¨×™×” ×œ×¦×¤×™×™×” ×‘×¢×™×¦×•×‘×™×</div>';
        document.getElementById('items-header').textContent = '×¢×™×¦×•×‘×™×';
      } catch (error) {
        console.error('Error deleting category:', error);
        alert('×©×’×™××” ×‘××—×™×§×ª ×”×§×˜×’×•×¨×™×”: ' + error.message);
      }
    };

    // ========== USERS MANAGEMENT ==========
    
    // Load users with credits > 3 OR subscription > 0
    async function loadPremiumUsers() {
      const usersList = document.getElementById('users-list');
      const usersLoading = document.getElementById('users-loading');
      
      if (!usersList) return;
      
      usersList.innerHTML = '';
      usersLoading.classList.remove('hidden');

      try {
        // Query users with credits > 3
        const creditsQuery = query(
          collection(db, 'users'),
          where('credits', '>', 3)
        );
        
        // Query users with subscription > 0
        const subscriptionQuery = query(
          collection(db, 'users'),
          where('subscription', '>', 0)
        );
        
        // Execute both queries
        const [creditsSnapshot, subscriptionSnapshot] = await Promise.all([
          getDocs(creditsQuery),
          getDocs(subscriptionQuery)
        ]);
        
        // Merge results and remove duplicates
        const usersMap = new Map();
        
        creditsSnapshot.forEach((docSnap) => {
          usersMap.set(docSnap.id, { id: docSnap.id, ...docSnap.data() });
        });
        
        subscriptionSnapshot.forEach((docSnap) => {
          usersMap.set(docSnap.id, { id: docSnap.id, ...docSnap.data() });
        });
        
        const users = Array.from(usersMap.values());
        
        if (users.length === 0) {
          usersList.innerHTML = '<div class="text-gray-400 text-center py-8">××™×Ÿ ××©×ª××©×™× ×¢× ×× ×•×™ ××• ×§×¨×“×™×˜×™×</div>';
          return;
        }

        // Sort by subscription desc, then credits desc
        users.sort((a, b) => {
          if ((b.subscription || 0) !== (a.subscription || 0)) {
            return (b.subscription || 0) - (a.subscription || 0);
          }
          return (b.credits || 0) - (a.credits || 0);
        });

        // Calculate MRR - only for users with valid payment source
        let mrr = 0;
        let paidUsersCount = 0;
        const mrrBreakdown = { 450: 0, 200: 0, 50: 0, 40: 0 };
        
        users.forEach((user) => {
          // Only count users with lastPaymentEvent or lastPurchaseId
          if (!user.lastPaymentEvent && !user.lastPurchaseId) return;
          
          const credits = user.credits || 0;
          if (credits >= 450) {
            mrr += 100;
            mrrBreakdown[450]++;
            paidUsersCount++;
          } else if (credits >= 200) {
            mrr += 50;
            mrrBreakdown[200]++;
            paidUsersCount++;
          } else if (credits >= 50) {
            mrr += 20;
            mrrBreakdown[50]++;
            paidUsersCount++;
          } else if (credits >= 40) {
            mrr += 15;
            mrrBreakdown[40]++;
            paidUsersCount++;
          }
        });

        // Update MRR display
        document.getElementById('mrr-total').textContent = `â‚ª${mrr}`;
        document.getElementById('mrr-users').textContent = `${paidUsersCount} ××©×œ××™×`;
        document.getElementById('mrr-breakdown').innerHTML = `
          <span class="text-purple-300">450: ${mrrBreakdown[450]}</span>
          <span class="text-blue-300">200: ${mrrBreakdown[200]}</span>
          <span class="text-emerald-300">50: ${mrrBreakdown[50]}</span>
          <span class="text-yellow-300">40: ${mrrBreakdown[40]}</span>
        `;

        // Render users
        users.forEach((user) => {
          const userEl = document.createElement('div');
          userEl.className = 'bg-gray-800/50 rounded-xl border border-gray-700/50 p-4 hover:border-purple-500/30 transition-all';
          
          const lastActive = user.lastActive?.toDate?.();
          const lastActiveStr = lastActive ? lastActive.toLocaleDateString('he-IL') + ' ' + lastActive.toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' }) : '×œ× ×™×“×•×¢';
          
          const canceledAt = user.canceledAt?.toDate?.();
          const canceledStr = canceledAt ? canceledAt.toLocaleDateString('he-IL') : null;
          
          const subscriptionLabels = {
            0: '×œ×œ× ×× ×•×™',
            1: 'Basic',
            2: 'Pro',
            3: 'Premium'
          };
          
          // Determine payment source
          const paymentSource = user.lastPaymentEvent ? 'GROW' : (user.lastPurchaseId ? 'MOBILE' : '?');
          const paymentSourceColor = user.lastPaymentEvent ? 'text-blue-400 bg-blue-500/20' : (user.lastPurchaseId ? 'text-orange-400 bg-orange-500/20' : 'text-gray-400 bg-gray-500/20');
          
          userEl.innerHTML = `
            <div class="flex items-start justify-between gap-4">
              <div class="flex-1 min-w-0">
                <div class="flex items-center gap-2 mb-2">
                  <p class="text-sm font-mono text-purple-400 truncate">${user.id}</p>
                  <button 
                    onclick="copyToClipboard('${user.id}')"
                    class="text-xs bg-gray-700/50 hover:bg-purple-600/30 text-gray-400 hover:text-purple-400 px-2 py-0.5 rounded transition-all"
                  >
                    ğŸ“‹
                  </button>
                  <span class="text-xs px-2 py-0.5 rounded font-medium ${paymentSourceColor}">${paymentSource}</span>
                </div>
                ${user.email ? `<p class="text-sm text-gray-300 mb-1">ğŸ“§ ${user.email}</p>` : ''}
                <div class="flex flex-wrap gap-3 text-xs text-gray-400">
                  <span>ğŸ“± ${user.deviceBrand || 'Unknown'}</span>
                  <span>ğŸ• ${lastActiveStr}</span>
                </div>
                ${user.lastPurchaseId ? `<p class="text-xs text-orange-400 mt-1">ğŸ§¾ ${user.lastPurchaseId}</p>` : ''}
                ${canceledStr ? `<p class="text-xs text-red-400 mt-2">âŒ ×‘×•×˜×œ ×‘: ${canceledStr}</p>` : ''}
              </div>
              <div class="flex flex-col items-end gap-2">
                <div class="flex items-center gap-3">
                  <div class="text-center">
                    <p class="text-lg font-bold ${user.subscription > 0 ? 'text-emerald-400' : 'text-gray-500'}">${subscriptionLabels[user.subscription] || user.subscription}</p>
                    <p class="text-xs text-gray-500">×× ×•×™</p>
                  </div>
                  <div class="text-center">
                    <p class="text-lg font-bold ${user.credits > 0 ? 'text-yellow-400' : 'text-gray-500'}">${user.credits || 0}</p>
                    <p class="text-xs text-gray-500">×§×¨×“×™×˜×™×</p>
                  </div>
                </div>
                ${(user.subscription > 0 || user.credits > 3) && !canceledStr ? `
                  <button 
                    onclick="cancelUserSubscription('${user.id}')"
                    class="bg-red-600/20 hover:bg-red-600/40 text-red-400 px-3 py-1.5 rounded-lg text-xs transition-colors border border-red-600/30"
                  >
                    âŒ ×‘×˜×œ ×× ×•×™
                  </button>
                ` : ''}
              </div>
            </div>
          `;
          usersList.appendChild(userEl);
        });

        document.getElementById('users-count').textContent = `${users.length} ××©×ª××©×™×`;
      } catch (error) {
        console.error('Error loading users:', error);
        usersList.innerHTML = `<div class="text-red-400 text-center py-8">×©×’×™××”: ${error.message}</div>`;
      } finally {
        usersLoading.classList.add('hidden');
      }
    }
    window.loadPremiumUsers = loadPremiumUsers;

    // Cancel user subscription
    window.cancelUserSubscription = async (userId) => {
      if (!confirm(`×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ×‘×˜×œ ××ª ×”×× ×•×™ ×©×œ ××©×ª××© ${userId.slice(0, 12)}...?\n\n×¤×¢×•×œ×” ×–×• ×ª××¤×¡ ××ª ×”×× ×•×™ ×•×”×§×¨×“×™×˜×™× ×œ-0.`)) return;

      try {
        await updateDoc(doc(db, 'users', userId), {
          subscription: 0,
          credits: 0,
          canceledAt: serverTimestamp()
        });
        
        alert('×”×× ×•×™ ×‘×•×˜×œ ×‘×”×¦×œ×—×”');
        await loadPremiumUsers();
      } catch (error) {
        console.error('Error canceling subscription:', error);
        alert('×©×’×™××” ×‘×‘×™×˜×•×œ ×”×× ×•×™: ' + error.message);
      }
    };

    // Copy to clipboard helper
    window.copyToClipboard = async (text) => {
      try {
        await navigator.clipboard.writeText(text);
      } catch (err) {
        const textArea = document.createElement('textarea');
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
      }
    };
  </script>
  <style>
    body {
      background: linear-gradient(135deg, #0f0f1a 0%, #1a1a2e 50%, #0f0f1a 100%);
      min-height: 100vh;
    }
    .line-clamp-3 {
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
  </style>
</head>
<body class="text-white font-sans">
  <!-- Login Section -->
  <div id="login-section" class="min-h-screen flex items-center justify-center p-4">
    <div class="bg-gray-800/50 backdrop-blur-xl rounded-2xl p-8 w-full max-w-md border border-gray-700/50">
      <h1 class="text-2xl font-bold text-center mb-2">ğŸ” Admin Panel</h1>
      <p class="text-gray-400 text-center text-sm mb-6">×”×ª×—×‘×¨×•×ª ×œ×¤×× ×œ × ×™×”×•×œ</p>
      
      <form onsubmit="handleLogin(event)" class="space-y-4">
        <div>
          <label class="block text-sm text-gray-400 mb-1">××™××™×™×œ</label>
          <input 
            type="email" 
            id="email" 
            required
            class="w-full bg-gray-900/50 border border-gray-700 rounded-xl px-4 py-3 text-white placeholder-gray-500 focus:outline-none focus:border-purple-500 transition-colors"
            placeholder="admin@example.com"
          >
        </div>
        <div>
          <label class="block text-sm text-gray-400 mb-1">×¡×™×¡××”</label>
          <input 
            type="password" 
            id="password" 
            required
            class="w-full bg-gray-900/50 border border-gray-700 rounded-xl px-4 py-3 text-white placeholder-gray-500 focus:outline-none focus:border-purple-500 transition-colors"
            placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
          >
        </div>
        
        <div id="error-msg" class="hidden text-red-400 text-sm text-center bg-red-500/10 rounded-lg p-3"></div>
        
        <button 
          type="submit"
          class="w-full bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white font-medium py-3 rounded-xl transition-all hover:shadow-lg hover:shadow-purple-500/25"
        >
          ×”×ª×—×‘×¨
        </button>
      </form>
      
      <p class="text-center text-gray-600 text-xs mt-6">×’×™×©×” ××•×’×‘×œ×ª ×œ×× ×”×œ×™× ×‘×œ×‘×“</p>
    </div>
  </div>

  <!-- Admin Section -->
  <div id="admin-section" class="hidden min-h-screen">
    <!-- Header -->
    <header class="bg-gray-900/80 backdrop-blur-xl border-b border-gray-700/50 sticky top-0 z-50">
      <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
        <div class="flex items-center gap-4">
          <h1 class="text-xl font-bold">ğŸ“Š Admin Control Panel</h1>
          <span id="user-info" class="text-sm text-gray-400"></span>
        </div>
        <div class="flex items-center gap-3">
          <div class="flex items-center gap-2">
            <input 
              type="text" 
              id="uid-filter" 
              placeholder="×¡× ×Ÿ ×œ×¤×™ UID..."
              onkeydown="if(event.key === 'Enter') refreshHistory()"
              class="bg-gray-900/50 border border-gray-700 rounded-lg px-3 py-2 text-sm text-white placeholder-gray-500 focus:outline-none focus:border-purple-500 transition-colors w-48"
            >
            <button 
              onclick="clearUidFilter()"
              class="bg-gray-800 hover:bg-gray-700 text-gray-400 hover:text-white px-3 py-2 rounded-lg text-sm transition-colors"
              title="× ×§×” ×¡×™× ×•×Ÿ"
            >
              âœ•
            </button>
          </div>
          <button 
            onclick="refreshHistory()"
            class="bg-gray-800 hover:bg-gray-700 text-white px-4 py-2 rounded-lg text-sm transition-colors flex items-center gap-2"
          >
            ğŸ”„ ×¨×¢× ×Ÿ
          </button>
          <button 
            onclick="handleLogout()"
            class="bg-red-600/20 hover:bg-red-600/30 text-red-400 px-4 py-2 rounded-lg text-sm transition-colors"
          >
            ×”×ª× ×ª×§
          </button>
        </div>
      </div>
    </header>

    <!-- Tab Navigation -->
    <div class="max-w-7xl mx-auto px-4 pt-6">
      <div class="flex gap-2">
        <button 
          id="history-tab-btn"
          onclick="switchTab('history')"
          class="bg-purple-600 text-white px-6 py-2.5 rounded-xl font-medium transition-all hover:opacity-90"
        >
          ğŸ“Š ×”×™×¡×˜×•×¨×™×™×ª ×™×¦×™×¨×•×ª
        </button>
        <button 
          id="predesigns-tab-btn"
          onclick="switchTab('predesigns')"
          class="bg-gray-800 text-white px-6 py-2.5 rounded-xl font-medium transition-all hover:opacity-90"
        >
          ğŸ¨ ×¢×™×¦×•×‘×™× ××•×›× ×™×
        </button>
        <button 
          id="users-tab-btn"
          onclick="switchTab('users')"
          class="bg-gray-800 text-white px-6 py-2.5 rounded-xl font-medium transition-all hover:opacity-90"
        >
          ğŸ‘¥ × ×™×”×•×œ ××©×ª××©×™×
        </button>
      </div>
    </div>

    <!-- Content -->
    <main class="max-w-7xl mx-auto px-4 py-6">
      
      <!-- History Tab Content -->
      <div id="history-tab-content">
        
        <!-- Generation Stats Chart -->
        <div id="generation-chart-container" class="bg-gray-800/50 rounded-2xl border border-gray-700/50 p-6 mb-6">
          <div class="flex items-center justify-between mb-4">
            <div>
              <h3 class="font-semibold text-white text-lg">ğŸ“ˆ ×™×¦×™×¨×•×ª ×ª××•× ×” - 14 ×™××™× ××—×¨×•× ×™×</h3>
              <p class="text-sm text-gray-400 mt-1">×¡×š ×›×œ ×”×™×¦×™×¨×•×ª ××¡×•×’ imageGeneration</p>
            </div>
            <div class="flex items-center gap-6">
              <div class="text-center">
                <p id="total-generations" class="text-2xl font-bold text-purple-400">-</p>
                <p class="text-xs text-gray-500">×¡×”"×› ×™×¦×™×¨×•×ª</p>
              </div>
              <div class="text-center">
                <p id="avg-daily" class="text-2xl font-bold text-emerald-400">-</p>
                <p class="text-xs text-gray-500">×××•×¦×¢ ×™×•××™</p>
              </div>
              <button 
                onclick="loadGenerationStats()"
                class="bg-gray-700 hover:bg-gray-600 text-white px-3 py-2 rounded-lg text-sm transition-colors"
                title="×¨×¢× ×Ÿ ×’×¨×£"
              >
                ğŸ”„
              </button>
            </div>
          </div>
          
          <!-- Chart Loading -->
          <div id="chart-loading" class="hidden flex items-center justify-center py-8">
            <div class="w-6 h-6 border-4 border-purple-500/30 border-t-purple-500 rounded-full animate-spin"></div>
            <span class="mr-3 text-gray-400">×˜×•×¢×Ÿ ×¡×˜×˜×™×¡×˜×™×§×•×ª...</span>
          </div>
          
          <!-- Chart Error -->
          <div id="chart-error" class="hidden text-red-400 text-sm text-center py-4"></div>
          
          <!-- Chart Canvas -->
          <div class="h-64">
            <canvas id="generationChart"></canvas>
          </div>
        </div>

        <div class="flex items-center justify-between mb-6">
          <h2 id="results-header" class="text-lg font-semibold text-gray-300">30 ×”×¨×©×•××•×ª ×”××—×¨×•× ×•×ª</h2>
        </div>

        <!-- Loading -->
        <div id="loading" class="hidden flex items-center justify-center py-12">
          <div class="w-8 h-8 border-4 border-purple-500/30 border-t-purple-500 rounded-full animate-spin"></div>
        </div>

        <!-- History Grid -->
        <div id="history-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        </div>
      </div>

      <!-- Preset Designs Tab Content -->
      <div id="predesigns-tab-content" class="hidden">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          
          <!-- Left Column: Categories Management -->
          <div class="lg:col-span-1 space-y-6">
            
            <!-- Add Category -->
            <div class="bg-gray-800/50 rounded-2xl border border-gray-700/50 p-5">
              <h3 class="font-semibold text-white mb-4">â• ×”×•×¡×£ ×§×˜×’×•×¨×™×”</h3>
              <div class="flex gap-2">
                <input 
                  type="text"
                  id="new-category-input"
                  placeholder="×©× ×”×§×˜×’×•×¨×™×” (×œ×“×•×’××”: ××˜×‘×—×™×)"
                  onkeydown="if(event.key === 'Enter') addCategory()"
                  class="flex-1 bg-gray-900/50 border border-gray-700 rounded-xl px-4 py-2.5 text-white placeholder-gray-500 focus:outline-none focus:border-purple-500 transition-colors"
                >
                <button 
                  onclick="addCategory()"
                  class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2.5 rounded-xl transition-colors"
                >
                  ×”×•×¡×£
                </button>
              </div>
            </div>

            <!-- Categories List -->
            <div class="bg-gray-800/50 rounded-2xl border border-gray-700/50 p-5">
              <div class="flex items-center justify-between mb-4">
                <h3 class="font-semibold text-white">ğŸ“ ×§×˜×’×•×¨×™×•×ª ×§×™×™××•×ª</h3>
              </div>
              <div id="categories-list" class="space-y-2">
                <div class="text-gray-400 text-center py-4">×˜×•×¢×Ÿ...</div>
              </div>
            </div>

            <!-- Delete Category Button (shows when category selected) -->
            <div id="delete-category-section" class="hidden">
              <button 
                id="delete-category-btn"
                class="w-full bg-red-600/20 hover:bg-red-600/30 text-red-400 border border-red-600/30 px-4 py-3 rounded-xl transition-colors text-sm"
              >
                ğŸ—‘ï¸ ××—×§ ×§×˜×’×•×¨×™×” × ×‘×—×¨×ª
              </button>
            </div>
          </div>

          <!-- Right Column: Items Management -->
          <div class="lg:col-span-2 space-y-6">
            
            <!-- Add Design Item -->
            <div class="bg-gray-800/50 rounded-2xl border border-gray-700/50 p-5">
              <h3 class="font-semibold text-white mb-4">ğŸ–¼ï¸ ×”×•×¡×£ ×¢×™×¦×•×‘ ×—×“×©</h3>
              <form onsubmit="addDesignItem(event)" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label class="block text-sm text-gray-400 mb-1">×§×˜×’×•×¨×™×”</label>
                    <select 
                      id="category-select"
                      required
                      class="w-full bg-gray-900/50 border border-gray-700 rounded-xl px-4 py-2.5 text-white focus:outline-none focus:border-purple-500 transition-colors"
                    >
                      <option value="">×‘×—×¨ ×§×˜×’×•×¨×™×”...</option>
                    </select>
                  </div>
                  <div>
                    <label class="block text-sm text-gray-400 mb-1">×›×•×ª×¨×ª (××¤×ª×—)</label>
                    <input 
                      type="text"
                      id="item-title"
                      required
                      placeholder="×œ×“×•×’××”: modern_kitchen_1"
                      class="w-full bg-gray-900/50 border border-gray-700 rounded-xl px-4 py-2.5 text-white placeholder-gray-500 focus:outline-none focus:border-purple-500 transition-colors"
                    >
                  </div>
                </div>
                
                <div>
                  <label class="block text-sm text-gray-400 mb-1">×ª××•× ×”</label>
                  <input 
                    type="file"
                    id="item-image"
                    accept="image/*"
                    required
                    onchange="previewImage(this)"
                    class="w-full bg-gray-900/50 border border-gray-700 rounded-xl px-4 py-2.5 text-white file:mr-4 file:py-1 file:px-3 file:rounded-lg file:border-0 file:bg-purple-600 file:text-white file:cursor-pointer hover:file:bg-purple-700 focus:outline-none focus:border-purple-500 transition-colors"
                  >
                </div>

                <!-- Image Preview -->
                <div id="image-preview" class="hidden">
                  <img id="preview-img" class="max-h-48 rounded-xl border border-gray-700">
                </div>

                <!-- Progress Bar -->
                <div id="upload-progress" class="hidden">
                  <div class="w-full bg-gray-700 rounded-full h-2">
                    <div class="progress-fill bg-purple-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                  </div>
                  <p class="text-xs text-gray-400 mt-1 text-center">××¢×œ×” ×•××¢×‘×“ ×ª××•× ×”...</p>
                </div>

                <button 
                  type="submit"
                  id="add-item-btn"
                  class="w-full bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white font-medium py-3 rounded-xl transition-all hover:shadow-lg hover:shadow-purple-500/25"
                >
                  ×”×•×¡×£ ×¢×™×¦×•×‘
                </button>
              </form>
            </div>

            <!-- Items Grid -->
            <div class="bg-gray-800/50 rounded-2xl border border-gray-700/50 p-5">
              <h3 id="items-header" class="font-semibold text-white mb-4">×¢×™×¦×•×‘×™×</h3>
              <div id="category-items-grid" class="grid grid-cols-2 md:grid-cols-3 gap-4">
                <div class="col-span-full text-gray-400 text-center py-8">×‘×—×¨ ×§×˜×’×•×¨×™×” ×œ×¦×¤×™×™×” ×‘×¢×™×¦×•×‘×™×</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Users Tab Content -->
      <div id="users-tab-content" class="hidden">
        <!-- MRR Summary -->
        <div class="bg-gradient-to-r from-emerald-900/30 to-blue-900/30 rounded-2xl border border-emerald-500/30 p-6 mb-6">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm text-emerald-300 mb-1">ğŸ’° MRR (Monthly Recurring Revenue)</p>
              <p id="mrr-total" class="text-4xl font-bold text-emerald-400">â‚ª0</p>
              <p id="mrr-users" class="text-sm text-gray-400 mt-1">0 ××©×œ××™×</p>
            </div>
            <div class="text-right">
              <p class="text-xs text-gray-400 mb-2">×¤×™×¨×•×˜ ×œ×¤×™ ×—×‘×™×œ×”:</p>
              <div id="mrr-breakdown" class="flex gap-4 text-sm">
                <span class="text-purple-300">450: 0</span>
                <span class="text-blue-300">200: 0</span>
                <span class="text-emerald-300">50: 0</span>
                <span class="text-yellow-300">40: 0</span>
              </div>
              <p class="text-xs text-gray-500 mt-2">450=â‚ª100 | 200=â‚ª50 | 50=â‚ª20 | 40=â‚ª15</p>
            </div>
          </div>
        </div>

        <div class="bg-gray-800/50 rounded-2xl border border-gray-700/50 p-6">
          <div class="flex items-center justify-between mb-6">
            <div>
              <h3 class="font-semibold text-white text-lg">ğŸ‘¥ ××©×ª××©×™× ×¢× ×× ×•×™ ××• ×§×¨×“×™×˜×™×</h3>
              <p class="text-sm text-gray-400 mt-1">××©×ª××©×™× ×¢× credits &gt; 3 ××• subscription &gt; 0</p>
            </div>
            <div class="flex items-center gap-3">
              <span id="users-count" class="text-sm text-purple-400"></span>
              <button 
                onclick="loadPremiumUsers()"
                class="bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded-lg text-sm transition-colors"
              >
                ğŸ”„ ×¨×¢× ×Ÿ
              </button>
            </div>
          </div>

          <!-- Loading -->
          <div id="users-loading" class="hidden flex items-center justify-center py-12">
            <div class="w-8 h-8 border-4 border-purple-500/30 border-t-purple-500 rounded-full animate-spin"></div>
          </div>

          <!-- Users List -->
          <div id="users-list" class="space-y-3">
            <div class="text-gray-400 text-center py-8">×œ×—×¥ ×¢×œ ×”×˜××‘ ×›×“×™ ×œ×˜×¢×•×Ÿ ××©×ª××©×™×</div>
          </div>
        </div>
      </div>
    </main>
  </div>
</body>
</html>

