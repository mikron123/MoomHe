<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Control Panel - Moomhe</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { getFirestore, collection, query, orderBy, limit, getDocs, where } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyDexERfe7htllA1aq7vlbnyQAmfgjx6HnI",
      authDomain: "moomhe-6de30.firebaseapp.com",
      projectId: "moomhe-6de30",
      storageBucket: "moomhe-6de30.firebasestorage.app",
      messagingSenderId: "951714207506",
      appId: "1:951714207506:web:0e3a50f5d663095e4345cb",
      measurementId: "G-S5QD3W3XV9"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const ADMIN_UID = 'OBAc1IAmd8fPhOJyKFl0PXx5Kqu1';

    // DOM Elements
    const loginSection = document.getElementById('login-section');
    const adminSection = document.getElementById('admin-section');
    const errorMsg = document.getElementById('error-msg');
    const historyGrid = document.getElementById('history-grid');
    const loadingIndicator = document.getElementById('loading');
    const userInfo = document.getElementById('user-info');

    // Check auth state
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        if (user.uid === ADMIN_UID) {
          loginSection.classList.add('hidden');
          adminSection.classList.remove('hidden');
          userInfo.textContent = `××—×•×‘×¨ ×›: ${user.email}`;
          await loadHistory();
        } else {
          errorMsg.textContent = '××™×Ÿ ×œ×š ×”×¨×©××•×ª ×’×™×©×” ×œ×“×£ ×–×”';
          errorMsg.classList.remove('hidden');
          await signOut(auth);
        }
      } else {
        loginSection.classList.remove('hidden');
        adminSection.classList.add('hidden');
      }
    });

    // Login handler
    window.handleLogin = async (e) => {
      e.preventDefault();
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      errorMsg.classList.add('hidden');

      try {
        await signInWithEmailAndPassword(auth, email, password);
      } catch (error) {
        errorMsg.textContent = '×©×’×™××” ×‘×”×ª×—×‘×¨×•×ª: ' + error.message;
        errorMsg.classList.remove('hidden');
      }
    };

    // Logout handler
    window.handleLogout = async () => {
      await signOut(auth);
    };

    // Load history
    async function loadHistory() {
      loadingIndicator.classList.remove('hidden');
      historyGrid.innerHTML = '';

      try {
        const uidFilter = document.getElementById('uid-filter').value.trim();
        
        let historyQuery;
        if (uidFilter) {
          historyQuery = query(
            collection(db, 'userHistory'),
            where('userId', '==', uidFilter),
            orderBy('createdAt', 'desc'),
            limit(50)
          );
        } else {
          historyQuery = query(
            collection(db, 'userHistory'),
            orderBy('createdAt', 'desc'),
            limit(30)
          );
        }

        const snapshot = await getDocs(historyQuery);
        
        if (snapshot.empty) {
          historyGrid.innerHTML = '<p class="text-gray-400 col-span-full text-center py-8">××™×Ÿ ×”×™×¡×˜×•×¨×™×” ×œ×”×¦×’×”</p>';
          updateResultsHeader(0, uidFilter);
          return;
        }

        let count = 0;
        snapshot.forEach((doc) => {
          const data = doc.data();
          // Skip uploaded type records - only show generated
          if (data.type === 'uploaded') return;
          const card = createHistoryCard(doc.id, data);
          historyGrid.appendChild(card);
          count++;
        });
        
        updateResultsHeader(count, uidFilter);

      } catch (error) {
        console.error('Error loading history:', error);
        historyGrid.innerHTML = `<p class="text-red-400 col-span-full text-center py-8">×©×’×™××” ×‘×˜×¢×™× ×ª ×”×™×¡×˜×•×¨×™×”: ${error.message}</p>`;
      } finally {
        loadingIndicator.classList.add('hidden');
      }
    }

    // Refresh handler
    window.refreshHistory = loadHistory;

    // Clear UID filter
    window.clearUidFilter = () => {
      document.getElementById('uid-filter').value = '';
      loadHistory();
    };

    // Filter by specific user
    window.filterByUser = (userId) => {
      document.getElementById('uid-filter').value = userId;
      loadHistory();
    };

    // Update header based on filter state
    function updateResultsHeader(count, uidFilter) {
      const header = document.getElementById('results-header');
      if (uidFilter) {
        header.innerHTML = `<span class="text-purple-400">${count}</span> ×ª×•×¦××•×ª ×¢×‘×•×¨ UID: <span class="font-mono text-purple-400">${uidFilter.slice(0, 12)}...</span>`;
      } else {
        header.textContent = count > 0 ? `${count} ×”×¨×©×•××•×ª ×”××—×¨×•× ×•×ª` : '30 ×”×¨×©×•××•×ª ×”××—×¨×•× ×•×ª';
      }
    }

    // Create history card
    function createHistoryCard(id, data) {
      const card = document.createElement('div');
      card.className = 'bg-gray-800/50 rounded-2xl border border-gray-700/50 overflow-hidden hover:border-purple-500/50 transition-all';

      const beforeImage = data.originalImageUrl || data.imageUrl || '';
      const afterImage = data.result?.storageUrl || '';
      const prompt = data.originalPrompt || data.prompt || '××™×Ÿ ×¤×¨×•××¤×˜';
      const createdAt = data.createdAt?.toDate?.() || new Date();
      const formattedDate = createdAt.toLocaleDateString('he-IL') + ' ' + createdAt.toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' });

      card.innerHTML = `
        <div class="p-4">
          <div class="flex items-center justify-between mb-3">
            <span class="text-xs text-purple-400 font-medium">${formattedDate}</span>
            <span class="text-xs text-gray-500 font-mono">${id.slice(0, 8)}...</span>
          </div>
          
          <div class="grid grid-cols-2 gap-3 mb-4">
            <div>
              <p class="text-xs text-gray-500 mb-1">×œ×¤× ×™</p>
              ${beforeImage ? 
                `<img src="${beforeImage}" alt="Before" class="w-full h-32 object-cover rounded-lg bg-gray-700 cursor-pointer hover:opacity-80 transition-opacity" onclick="window.open('${beforeImage}', '_blank')">` : 
                `<div class="w-full h-32 bg-gray-700 rounded-lg flex items-center justify-center text-gray-500 text-xs">××™×Ÿ ×ª××•× ×”</div>`
              }
            </div>
            <div>
              <p class="text-xs text-gray-500 mb-1">××—×¨×™</p>
              ${afterImage ? 
                `<img src="${afterImage}" alt="After" class="w-full h-32 object-cover rounded-lg bg-gray-700 cursor-pointer hover:opacity-80 transition-opacity" onclick="window.open('${afterImage}', '_blank')">` : 
                `<div class="w-full h-32 bg-gray-700 rounded-lg flex items-center justify-center text-gray-500 text-xs">××™×Ÿ ×ª×•×¦××”</div>`
              }
            </div>
          </div>
          
          <div class="bg-gray-900/50 rounded-lg p-3">
            <p class="text-xs text-gray-500 mb-1">×¤×¨×•××¤×˜:</p>
            <p class="text-sm text-gray-300 line-clamp-3">${prompt}</p>
          </div>
          
          ${data.generationCount !== undefined ? `<p class="text-xs text-emerald-400 mt-2">ğŸ”¢ Generation Count: ${data.generationCount}</p>` : ''}
          ${data.userId ? `
            <div class="flex items-center gap-2 mt-2">
              <p class="text-xs text-gray-600 font-mono">User: ${data.userId.slice(0, 12)}...</p>
              <button 
                onclick="copyUserId('${data.userId}')" 
                class="copy-btn text-xs bg-gray-700/50 hover:bg-purple-600/30 text-gray-400 hover:text-purple-400 px-2 py-1 rounded transition-all flex items-center gap-1"
                title="Copy full UID"
              >
                <span class="copy-icon">ğŸ“‹</span>
                <span class="copy-text">Copy</span>
              </button>
              <button 
                onclick="filterByUser('${data.userId}')" 
                class="text-xs bg-purple-600/20 hover:bg-purple-600/40 text-purple-400 hover:text-purple-300 px-2 py-1 rounded transition-all flex items-center gap-1"
                title="×”×¦×’ ×¨×§ ××©×ª××© ×–×”"
              >
                ğŸ” ×¡× ×Ÿ
              </button>
            </div>
          ` : ''}
        </div>
      `;

      return card;
    }

    // Copy user ID to clipboard
    window.copyUserId = async (userId) => {
      try {
        await navigator.clipboard.writeText(userId);
        // Show feedback - find the clicked button and update it
        event.target.closest('.copy-btn').innerHTML = '<span class="copy-icon">âœ…</span><span class="copy-text">Copied!</span>';
        setTimeout(() => {
          event.target.closest('.copy-btn').innerHTML = '<span class="copy-icon">ğŸ“‹</span><span class="copy-text">Copy</span>';
        }, 1500);
      } catch (err) {
        console.error('Failed to copy:', err);
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = userId;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        event.target.closest('.copy-btn').innerHTML = '<span class="copy-icon">âœ…</span><span class="copy-text">Copied!</span>';
        setTimeout(() => {
          event.target.closest('.copy-btn').innerHTML = '<span class="copy-icon">ğŸ“‹</span><span class="copy-text">Copy</span>';
        }, 1500);
      }
    };
  </script>
  <style>
    body {
      background: linear-gradient(135deg, #0f0f1a 0%, #1a1a2e 50%, #0f0f1a 100%);
      min-height: 100vh;
    }
    .line-clamp-3 {
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
  </style>
</head>
<body class="text-white font-sans">
  <!-- Login Section -->
  <div id="login-section" class="min-h-screen flex items-center justify-center p-4">
    <div class="bg-gray-800/50 backdrop-blur-xl rounded-2xl p-8 w-full max-w-md border border-gray-700/50">
      <h1 class="text-2xl font-bold text-center mb-2">ğŸ” Admin Panel</h1>
      <p class="text-gray-400 text-center text-sm mb-6">×”×ª×—×‘×¨×•×ª ×œ×¤×× ×œ × ×™×”×•×œ</p>
      
      <form onsubmit="handleLogin(event)" class="space-y-4">
        <div>
          <label class="block text-sm text-gray-400 mb-1">××™××™×™×œ</label>
          <input 
            type="email" 
            id="email" 
            required
            class="w-full bg-gray-900/50 border border-gray-700 rounded-xl px-4 py-3 text-white placeholder-gray-500 focus:outline-none focus:border-purple-500 transition-colors"
            placeholder="admin@example.com"
          >
        </div>
        <div>
          <label class="block text-sm text-gray-400 mb-1">×¡×™×¡××”</label>
          <input 
            type="password" 
            id="password" 
            required
            class="w-full bg-gray-900/50 border border-gray-700 rounded-xl px-4 py-3 text-white placeholder-gray-500 focus:outline-none focus:border-purple-500 transition-colors"
            placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
          >
        </div>
        
        <div id="error-msg" class="hidden text-red-400 text-sm text-center bg-red-500/10 rounded-lg p-3"></div>
        
        <button 
          type="submit"
          class="w-full bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white font-medium py-3 rounded-xl transition-all hover:shadow-lg hover:shadow-purple-500/25"
        >
          ×”×ª×—×‘×¨
        </button>
      </form>
      
      <p class="text-center text-gray-600 text-xs mt-6">×’×™×©×” ××•×’×‘×œ×ª ×œ×× ×”×œ×™× ×‘×œ×‘×“</p>
    </div>
  </div>

  <!-- Admin Section -->
  <div id="admin-section" class="hidden min-h-screen">
    <!-- Header -->
    <header class="bg-gray-900/80 backdrop-blur-xl border-b border-gray-700/50 sticky top-0 z-50">
      <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
        <div class="flex items-center gap-4">
          <h1 class="text-xl font-bold">ğŸ“Š Admin Control Panel</h1>
          <span id="user-info" class="text-sm text-gray-400"></span>
        </div>
        <div class="flex items-center gap-3">
          <div class="flex items-center gap-2">
            <input 
              type="text" 
              id="uid-filter" 
              placeholder="×¡× ×Ÿ ×œ×¤×™ UID..."
              onkeydown="if(event.key === 'Enter') refreshHistory()"
              class="bg-gray-900/50 border border-gray-700 rounded-lg px-3 py-2 text-sm text-white placeholder-gray-500 focus:outline-none focus:border-purple-500 transition-colors w-48"
            >
            <button 
              onclick="clearUidFilter()"
              class="bg-gray-800 hover:bg-gray-700 text-gray-400 hover:text-white px-3 py-2 rounded-lg text-sm transition-colors"
              title="× ×§×” ×¡×™× ×•×Ÿ"
            >
              âœ•
            </button>
          </div>
          <button 
            onclick="refreshHistory()"
            class="bg-gray-800 hover:bg-gray-700 text-white px-4 py-2 rounded-lg text-sm transition-colors flex items-center gap-2"
          >
            ğŸ”„ ×¨×¢× ×Ÿ
          </button>
          <button 
            onclick="handleLogout()"
            class="bg-red-600/20 hover:bg-red-600/30 text-red-400 px-4 py-2 rounded-lg text-sm transition-colors"
          >
            ×”×ª× ×ª×§
          </button>
        </div>
      </div>
    </header>

    <!-- Content -->
    <main class="max-w-7xl mx-auto px-4 py-8">
      <div class="flex items-center justify-between mb-6">
        <h2 id="results-header" class="text-lg font-semibold text-gray-300">30 ×”×¨×©×•××•×ª ×”××—×¨×•× ×•×ª</h2>
      </div>

      <!-- Loading -->
      <div id="loading" class="hidden flex items-center justify-center py-12">
        <div class="w-8 h-8 border-4 border-purple-500/30 border-t-purple-500 rounded-full animate-spin"></div>
      </div>

      <!-- History Grid -->
      <div id="history-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
      </div>
    </main>
  </div>
</body>
</html>

